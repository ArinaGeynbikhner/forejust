const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// --------------------
// –ü–û–õ–£–ß–ê–ï–ú –¢–û–ö–ï–ù–´ –ò–ó URL
// --------------------
const params = new URLSearchParams(window.location.search);
let tokens = parseInt(params.get("tokens")) || 0;

const tokensEl = document.getElementById("tokens");
tokensEl.innerText = tokens;

// --------------------
// –ì–û–õ–û–° –ó–ê –≠–ö–°–ü–ï–†–¢–ê
// --------------------
function vote(caseId, choice) {
    tg.sendData(JSON.stringify({
        case_id: caseId,
        choice: choice
    }));

    alert("‚úÖ –í–∞—à –≥–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç!");
}

// --------------------
// –°–í–û–ô –ü–†–û–ì–ù–û–ó (–ü–õ–ê–¢–ù–û)
// --------------------
function customVote(caseId) {

    if (tokens <= 0) {
        alert("‚ùå –£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤");
        return;
    }

    const confirmPay = confirm(
        `‚úçÔ∏è –°–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ —Å—Ç–æ–∏—Ç 1 —Ç–æ–∫–µ–Ω\n\n` +
        `üíé –£ –≤–∞—Å —Å–µ–π—á–∞—Å: ${tokens}\n\n` +
        `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`
    );

    if (!confirmPay) {
        return;
    }

    const text = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø—Ä–æ–≥–Ω–æ–∑:");

    if (!text || text.trim().length < 3) {
        alert("‚ö†Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");
        return;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
    tg.sendData(JSON.stringify({
        case_id: caseId,
        choice: "custom",
        text: text
    }));

    // –û–±–Ω–æ–≤–ª—è–µ–º UI –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ
    tokens -= 1;
    tokensEl.innerText = tokens;

    alert("‚úÖ –ü—Ä–æ–≥–Ω–æ–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
}
