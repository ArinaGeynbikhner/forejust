const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// --------------------
// –¢–û–ö–ï–ù–´ –ò–ó URL
// --------------------
const params = new URLSearchParams(window.location.search);
let tokens = parseInt(params.get("tokens")) || 0;

const tokensEl = document.getElementById("tokens");
tokensEl.innerText = tokens;

// --------------------
// –î–ê–ù–ù–´–ï –ö–ï–ô–°–û–í
// --------------------
const cases = [
    {
        id: 1,
        title: "–í—ã–±–æ—Ä—ã –≤ X",
        description: "–ö—Ç–æ –ø–æ–±–µ–¥–∏—Ç –Ω–∞ –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç—Å–∫–∏—Ö –≤—ã–±–æ—Ä–∞—Ö –≤ —Å—Ç—Ä–∞–Ω–µ X?",
        experts: [
            { id: "expert_1", name: "–≠–∫—Å–ø–µ—Ä—Ç A", text: "–ü–æ–±–µ–¥–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ A" },
            { id: "expert_2", name: "–≠–∫—Å–ø–µ—Ä—Ç B", text: "–ü–æ–±–µ–¥–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ B" }
        ]
    },
    {
        id: 2,
        title: "–°–∞–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ç–∏–≤ Y",
        description: "–ë—É–¥—É—Ç –ª–∏ –≤–≤–µ–¥–µ–Ω—ã –Ω–æ–≤—ã–µ —Å–∞–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ç–∏–≤ —Å—Ç—Ä–∞–Ω—ã Y?",
        experts: [
            { id: "expert_1", name: "–≠–∫—Å–ø–µ—Ä—Ç A", text: "–°–∞–Ω–∫—Ü–∏–∏ –≤–≤–µ–¥—É—Ç" },
            { id: "expert_2", name: "–≠–∫—Å–ø–µ—Ä—Ç B", text: "–°–∞–Ω–∫—Ü–∏–π –Ω–µ –±—É–¥–µ—Ç" }
        ]
    }
];

// --------------------
// DOM –≠–õ–ï–ú–ï–ù–¢–´
// --------------------
const casesListEl = document.getElementById("cases-list");
const caseViewEl = document.getElementById("case-view");

// --------------------
// –†–ï–ù–î–ï–† –°–ü–ò–°–ö–ê –ö–ï–ô–°–û–í
// --------------------
function renderCases() {
    casesListEl.innerHTML = "";

    cases.forEach(c => {
        const div = document.createElement("div");
        div.className = "case";

        div.innerHTML = `
            <h2>üìä ${c.title}</h2>
            <p>${c.description}</p>
            <button class="primary" onclick="openCase(${c.id})">
                ‚ñ∂Ô∏è –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å
            </button>
        `;

        casesListEl.appendChild(div);
    });
}

// --------------------
// –û–¢–ö–†–´–¢–ò–ï –ö–ï–ô–°–ê
// --------------------
function openCase(caseId) {
    const c = cases.find(x => x.id === caseId);
    if (!c) return;

    casesListEl.style.display = "none";
    caseViewEl.style.display = "block";

    caseViewEl.innerHTML = `
        <button class="back" onclick="backToCases()">‚Üê –ù–∞–∑–∞–¥</button>

        <div class="case">
            <h2>${c.title}</h2>
            <p>${c.description}</p>

            ${c.experts.map(e => `
                <button class="primary" onclick="vote(${c.id}, '${e.id}')">
                    ${e.name}<br>
                    <small>${e.text}</small>
                </button>
            `).join("")}

            <button class="custom" onclick="customVote(${c.id})">
                ‚úçÔ∏è –°–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ (1 —Ç–æ–∫–µ–Ω)
            </button>
        </div>
    `;
}

// --------------------
// –ù–ê–ó–ê–î –ö –°–ü–ò–°–ö–£
// --------------------
function backToCases() {
    caseViewEl.style.display = "none";
    casesListEl.style.display = "block";
}

// --------------------
// –ì–û–õ–û–° –ó–ê –≠–ö–°–ü–ï–†–¢–ê
// --------------------
function vote(caseId, choice) {
    tg.sendData(JSON.stringify({
        case_id: caseId,
        choice: choice
    }));

    alert("‚úÖ –í–∞—à –≥–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç!");
}

// --------------------
// –°–í–û–ô –ü–†–û–ì–ù–û–ó (–ü–õ–ê–¢–ù–û)
// --------------------
function customVote(caseId) {

    if (tokens <= 0) {
        alert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤");
        return;
    }

    const ok = confirm(
        `‚úçÔ∏è –°–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ —Å—Ç–æ–∏—Ç 1 —Ç–æ–∫–µ–Ω\n\n` +
        `üíé –£ –≤–∞—Å: ${tokens}\n\n` +
        `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`
    );

    if (!ok) return;

    const text = prompt("–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑:");

    if (!text || text.trim().length < 3) {
        alert("‚ö†Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");
        return;
    }

    tg.sendData(JSON.stringify({
        case_id: caseId,
        choice: "custom",
        text: text
    }));

    tokens -= 1;
    tokensEl.innerText = tokens;

    alert("‚úÖ –ü—Ä–æ–≥–Ω–æ–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
}

// --------------------
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// --------------------
renderCases();
